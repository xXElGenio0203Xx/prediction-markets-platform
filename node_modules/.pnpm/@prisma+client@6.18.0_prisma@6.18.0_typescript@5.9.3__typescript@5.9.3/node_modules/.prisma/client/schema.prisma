// Prisma schema for Prediction Market with Supabase
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum OrderSide {
  BUY
  SELL
}

enum OrderType {
  LIMIT
  MARKET
}

enum OrderStatus {
  PENDING
  OPEN
  PARTIAL
  FILLED
  CANCELLED
}

enum MarketStatus {
  OPEN
  CLOSED
  RESOLVED
  CANCELLED
}

enum Outcome {
  YES
  NO
}

enum TransferType {
  DEPOSIT
  WITHDRAWAL
}

enum TransferStatus {
  PENDING
  COMPLETED
  FAILED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CREATED
}

// User model
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  handle       String?  @unique
  passwordHash String
  fullName     String?
  role         UserRole @default(USER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sessions               Session[]
  balance                Balance?
  orders                 Order[]
  trades                 Trade[]         @relation("UserTrades")
  positions              Position[]
  transfers              Transfer[]
  markets                Market[]        @relation("MarketCreator")
  reviewedMarketRequests MarketRequest[] @relation("MarketRequestReviewer")

  @@index([email])
  @@index([role])
}

// Session for JWT refresh tokens
model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  userAgent    String?
  ipAddress    String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
}

// Market model
model Market {
  id               String       @id @default(uuid())
  slug             String       @unique
  question         String
  imageUrl         String?
  description      String?
  category         String
  status           MarketStatus @default(OPEN)
  createdBy        String
  closeTime        DateTime
  resolveTime      DateTime?
  outcome          Outcome?
  resolutionSource String?
  featured         Boolean      @default(false)
  volume24h        Decimal      @default(0) @db.Decimal(18, 4)
  liquidity        Decimal      @default(0) @db.Decimal(18, 4)
  yesPrice         Decimal      @default(0.5) @db.Decimal(18, 4)
  noPrice          Decimal      @default(0.5) @db.Decimal(18, 4)
  yesShares        Decimal      @default(0) @db.Decimal(18, 4)
  noShares         Decimal      @default(0) @db.Decimal(18, 4)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  creator            User           @relation("MarketCreator", fields: [createdBy], references: [id])
  orders             Order[]
  trades             Trade[]
  positions          Position[]
  candles            Candle[]
  createdFromRequest MarketRequest? @relation("CreatedFromRequest")

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([featured])
  @@index([closeTime])
  @@index([createdBy])
}

// Order model
model Order {
  id        String      @id @default(uuid())
  marketId  String
  userId    String
  side      OrderSide
  type      OrderType
  outcome   Outcome
  price     Decimal     @db.Decimal(18, 4)
  quantity  Decimal     @db.Decimal(18, 4)
  filled    Decimal     @default(0) @db.Decimal(18, 4)
  status    OrderStatus @default(PENDING)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  market     Market       @relation(fields: [marketId], references: [id], onDelete: Cascade)
  buyTrades  Trade[]      @relation("BuyOrder")
  sellTrades Trade[]      @relation("SellOrder")
  events     OrderEvent[]

  @@index([marketId, outcome, side, price, createdAt])
  @@index([userId, status])
  @@index([marketId, status])
}

// Trade model
model Trade {
  id          String   @id @default(uuid())
  marketId    String
  buyOrderId  String
  sellOrderId String
  buyerId     String
  sellerId    String
  outcome     Outcome
  price       Decimal  @db.Decimal(18, 4)
  quantity    Decimal  @db.Decimal(18, 4)
  createdAt   DateTime @default(now())

  market    Market @relation(fields: [marketId], references: [id], onDelete: Cascade)
  buyOrder  Order  @relation("BuyOrder", fields: [buyOrderId], references: [id])
  sellOrder Order  @relation("SellOrder", fields: [sellOrderId], references: [id])
  buyer     User   @relation("UserTrades", fields: [buyerId], references: [id])

  @@index([marketId, createdAt])
  @@index([buyOrderId])
  @@index([sellOrderId])
  @@index([buyerId])
}

// OrderEvent for audit trail
model OrderEvent {
  id        String   @id @default(uuid())
  orderId   String
  type      String
  data      Json
  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
}

// Balance model
model Balance {
  userId    String   @id
  available Decimal  @default(0) @db.Decimal(18, 4)
  locked    Decimal  @default(0) @db.Decimal(18, 4)
  total     Decimal  @default(0) @db.Decimal(18, 4)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Transfer model for deposits/withdrawals
model Transfer {
  id        String         @id @default(uuid())
  userId    String
  type      TransferType
  amount    Decimal        @db.Decimal(18, 4)
  status    TransferStatus @default(PENDING)
  createdAt DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status])
}

// Position model
model Position {
  id           String   @id @default(uuid())
  userId       String
  marketId     String
  outcome      Outcome
  quantity     Decimal  @default(0) @db.Decimal(18, 4)
  averagePrice Decimal  @default(0) @db.Decimal(18, 4)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([userId, marketId, outcome])
  @@index([userId])
  @@index([marketId])
}

// Candle model for price history
model Candle {
  id        String   @id @default(uuid())
  marketId  String
  outcome   Outcome
  timeframe String
  timestamp DateTime
  open      Decimal  @db.Decimal(18, 4)
  high      Decimal  @db.Decimal(18, 4)
  low       Decimal  @db.Decimal(18, 4)
  close     Decimal  @db.Decimal(18, 4)
  volume    Decimal  @db.Decimal(18, 4)

  market Market @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([marketId, outcome, timeframe, timestamp])
  @@index([marketId, outcome, timeframe, timestamp])
}

// Market Request model for user-submitted market suggestions
model MarketRequest {
  id                 String        @id @default(uuid())
  title              String
  description        String?
  category           String
  resolutionCriteria String
  suggestedCloseDate DateTime?
  requestedBy        String?
  requesterEmail     String?
  status             RequestStatus @default(PENDING)
  adminNotes         String?
  reviewedBy         String?
  reviewedAt         DateTime?
  createdMarketId    String?       @unique
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  reviewer      User?   @relation("MarketRequestReviewer", fields: [reviewedBy], references: [id])
  createdMarket Market? @relation("CreatedFromRequest", fields: [createdMarketId], references: [id])

  @@index([status])
  @@index([requestedBy])
  @@index([createdAt])
}
